# 智慧社区系统接口文档总结

## 一、系统架构概述

智慧社区系统采用全链路架构设计，包含Android终端、ESP32-S3硬件设备和阿里云ECS云服务器三个核心组件，实现了从硬件数据采集到Android应用展示的完整链路。

## 二、服务器配置

### 1. 基础配置
- **服务器地址**：8.134.63.151
- **ssh连接用户名**：root
- **ssh连接密码**：20040309Cal
- **API基础URL**：http://8.134.63.151:8080/
- **API版本前缀**：v1
- **API请求超时时间**：30秒

### 2. 开发/生产环境切换
- **开发环境**：支持localhost和局域网IP配置
- **生产环境**：已配置为阿里云ECS服务器

## 三、MySQL数据库设计

### 1. 核心数据表

| 表名 | 描述 | 主要字段 |
|------|------|----------|
| users | 用户信息表 | id, username, password, nickname, avatar, phone_number, community_id, role |
| devices | 设备信息表 | id, device_id, device_name, device_type, community_id, location, status |
| device_data | 设备数据表 | id, device_id, data_type, value, timestamp, location |
| security_events | 安全事件表 | id, event_type, device_id, location, timestamp, processed, description |

### 2. 数据库连接配置
- **远程访问**：已配置bind-address和ECS安全组规则
- **默认管理员**：用户名admin，密码SmartHome@2025

## 四、MQTT通信配置

### 1. 服务器配置
- **MQTT服务器URI**：tcp://8.134.63.151:1883
- **客户端ID前缀**：smart_community_android
- **用户名**：app_user
- **密码**：SmartHome@2025
- **连接超时**：10秒
- **心跳间隔**：20秒

### 2. 核心主题
- **设备状态主题**：smart_community/devices/+/status
- **传感器数据主题**：smart_community/sensors/+/data
- **安全事件主题**：smart_community/security/events
- **设备控制主题**：smart_community/devices/{deviceId}/control

### 3. 消息格式
- 采用JSON格式进行数据交换
- 支持设备属性上报、设置和安全提醒等功能

## 五、REST API接口

### 1. 用户认证接口

| 接口名称 | HTTP方法 | 路径 | 描述 |
|---------|----------|------|------|
| 用户登录 | POST | api/auth/login | 用户身份验证，返回Token和用户信息 |
| 刷新Token | POST | api/auth/refresh | 使用RefreshToken获取新的AccessToken |
| 获取用户信息 | GET | api/user/info | 获取当前登录用户的详细信息 |
| 更新用户信息 | PUT | api/user/info | 更新用户个人信息 |
| 用户登出 | POST | api/auth/logout | 清除用户登录状态 |

### 2. 设备管理接口

| 接口名称 | HTTP方法 | 路径 | 描述 |
|---------|----------|------|------|
| 获取设备列表 | GET | v1/devices | 获取所有设备列表（支持分页） |
| 获取分页设备 | GET | api/device/list/paged | 获取分页设备列表 |
| 获取设备详情 | GET | v1/devices/{deviceId} | 获取指定设备的详细信息 |
| 获取设备状态 | GET | v1/devices/{deviceId}/status | 获取指定设备的当前状态 |
| 发送设备命令 | POST | v1/devices/{deviceId}/command | 向指定设备发送控制命令 |
| 更新设备状态 | PUT | v1/devices/{deviceId}/status | 更新设备状态信息 |

### 3. 传感器数据接口

| 接口名称 | HTTP方法 | 路径 | 描述 |
|---------|----------|------|------|
| 获取传感器数据 | GET | v1/sensors/data | 获取传感器历史数据（支持时间范围和设备筛选） |
| 上报传感器数据 | POST | v1/data/report | 上报传感器采集数据到服务器 |

### 4. 安全事件接口

| 接口名称 | HTTP方法 | 路径 | 描述 |
|---------|----------|------|------|
| 获取安全事件 | GET | v1/security/events | 获取安全事件列表（支持处理状态筛选） |
| 获取事件详情 | GET | v1/security/events/{eventId} | 获取单个安全事件的详细信息 |
| 处理安全事件 | PUT | v1/security/events/{eventId}/process | 将安全事件标记为已处理 |

### 5. 社区信息接口

| 接口名称 | HTTP方法 | 路径 | 描述 |
|---------|----------|------|------|
| 获取社区信息 | GET | v1/community/info | 获取指定社区的详细信息 |

## 六、核心数据模型

### 1. 通用响应模型
- **ApiResponse<T>**：包含code（状态码）、message（消息）、data（响应数据）
- **PagedResponse<T>**：分页响应，包含content（数据列表）、分页信息

### 2. 用户相关模型
- **LoginRequest**：用户名、密码
- **LoginData**：token、refreshToken、user信息
- **UserInfo**：用户ID、用户名、昵称、头像、手机号等

### 3. 设备相关模型
- **DeviceStatus**：温度、湿度、电源状态、信号强度
- **DeviceCommand**：指令类型、参数

### 4. 传感器数据模型
- **SensorDataReport**：设备ID、数据类型、值、时间戳、地理位置
- **DataReportResponse**：上报ID、时间戳

### 5. 安全事件模型
- **SecurityEvent**：事件类型、设备ID、位置、时间戳、处理状态

## 七、安全与优化机制

### 1. Token管理
- 支持Token刷新机制
- 实现Token过期自动检测与刷新
- 使用Mutex避免并发刷新问题

### 2. 网络优化
- 添加请求重试机制（针对408、429、500等错误码）
- 配置合理的超时时间
- 实现日志开关控制

### 3. 数据验证
- 服务器端实现JWT Token验证
- 接口参数校验

## 八、部署与验证

### 1. 配置验证方法
- 提供AppConfig.validateConfig()方法检查配置完整性
- 支持配置摘要输出，便于调试

### 2. 测试方法
- 提供API接口测试curl命令
- MQTT连接测试步骤

总结：本系统实现了完整的物联网应用架构，通过REST API和MQTT协议实现了Android客户端、服务器和硬件设备之间的无缝通信，支持设备管理、数据采集和安全监控等核心功能。