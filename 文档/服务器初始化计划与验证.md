# 服务器初始化计划与验证

说明：基于接口文档提供的服务器信息与凭据，制定 SSH 连接、通信测试与初始化配置步骤，并记录当前连通性测试结果与后续操作清单。

一、目标与前提
- 服务器：8.134.63.151（阿里云 ECS）
- SSH 凭据（参考文档）：用户名 root，密码 20040309Cal
- REST API：http://8.134.63.151:8080/
- MQTT：tcp://8.134.63.151:1883，用户名 smarthome，密码 SmartHome@2025
- 数据库：MySQL（管理员 admin/SmartHome@2025）

二、本地连通性测试结果
- Ping：可达（延时约 16–19ms，0% 丢包）
- TCP 端口测试：22/8080/1883 均不可达（TcpTestSucceeded=False）
- HTTP GET http://8.134.63.151:8080/：超时
- 结论：服务器在线，但安全组或服务器防火墙未开放 SSH/HTTP/MQTT 端口。

三、云侧安全组与端口开放指引（需在阿里云控制台操作）
- 在 ECS 实例的“安全组”中添加入站规则：
  - TCP 22（SSH）
  - TCP 8080（HTTP API）
  - TCP 1883（MQTT，生产建议使用 8883/TLS）
  - TCP 3306（MySQL，建议仅开放给内网或指定源 IP）
- 源地址建议：优先指定固定公网 IP 或临时调试 IP，避免 0.0.0.0/0 全网开放。
- 若使用云防火墙/安全防护，请同步放通上述端口。

四、SSH 连接与初次登录步骤（端口开放后）
- 本地执行：
  - Windows PowerShell：ssh root@8.134.63.151
  - 首次登录后立即修改 root 密码，或创建非 root 管理员并禁用 root 远程登录。
- 创建管理员用户（示例）：
  - adduser admin
  - usermod -aG sudo admin
  - su - admin

五、服务器初始化配置（建议 Ubuntu/Debian 通用）
- 系统更新与基础工具：
  - apt update && apt -y upgrade
  - apt -y install vim git curl wget net-tools ufw ntp fail2ban unzip
- 时区与时间同步：
  - timedatectl set-timezone Asia/Shanghai
  - systemctl enable ntp && systemctl start ntp
- SSH 加固：
  - /etc/ssh/sshd_config：
    - PermitRootLogin no（禁用 root 远程登录，完成管理员创建后再改）
    - PasswordAuthentication no（改用密钥登录，先配置好密钥再关闭密码）
  - systemctl restart ssh
- 防火墙（UFW）：
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp
  - ufw allow 8080/tcp
  - ufw allow 1883/tcp（或 8883/tcp）
  - ufw allow 3306/tcp（如需远程访问，建议限制源 IP）
  - ufw enable
- 资源与日志：
  - 配置 swap（如内存不足时）
  - 日志轮转与磁盘监控（logrotate + 监控告警）

六、MQTT Broker 安装与配置
- 方案 A：Mosquitto（轻量）
  - apt -y install mosquitto mosquitto-clients
  - 编辑 /etc/mosquitto/mosquitto.conf：
    - listener 1883 0.0.0.0
    - allow_anonymous false
    - password_file /etc/mosquitto/passwd
  - 初始化用户：
    - mosquitto_passwd -c /etc/mosquitto/passwd smarthome（按文档密码 SmartHome@2025）
  - systemctl enable mosquitto && systemctl restart mosquitto
- 方案 B：EMQX（功能更强，建议生产）
  - 使用 Docker 部署，暴露 1883/8883，配置认证与 ACL。

七、MySQL 安装与配置
- 安装：
  - apt -y install mysql-server
  - 初始化安全配置：mysql_secure_installation（设置 root 密码、移除匿名用户、禁用远程 root）
- 远程访问：
  - 配置 bind-address（0.0.0.0 或内网地址），谨慎开放 3306；
  - 云侧与 UFW 放通规则，建议限制源 IP。
- 应用账户与表：
  - 创建应用数据库与用户（最低权限原则）；
  - 初始化核心表：users、devices、device_data、security_events。
  - 管理员账号 admin/SmartHome@2025 按需创建（生产建议更换强密码）。

八、后端 API 部署基线（占位）
- 运行环境：
  - Java 11；
  - Spring Boot 应用（端口 8080）。
- 服务守护与日志：
  - 使用 systemd 管理服务；
  - 日志输出到 /var/log/yourapp/（按天轮转）。
- 反向代理（可选）：
  - Nginx 反代 8080，启用 HTTPS；
  - 配置限流与超时策略。

九、验证用例（端口开放与服务启动后）
- SSH：ssh admin@8.134.63.151（密钥登录）
- HTTP API：
  - curl -m 10 http://8.134.63.151:8080/
  - 用户登录：curl -X POST http://8.134.63.151:8080/api/auth/login -d '{"username":"admin","password":"SmartHome@2025"}' -H 'Content-Type: application/json'
- MQTT：
  - 订阅状态：mosquitto_sub -h 8.134.63.151 -p 1883 -u smarthome -P SmartHome@2025 -t 'smart_community/devices/+/status' -v
  - 发布控制：mosquitto_pub -h 8.134.63.151 -p 1883 -u smarthome -P SmartHome@2025 -t 'smart_community/devices/{deviceId}/control' -m '{"cmd":"on"}'
- MySQL：
  - mysql -h 8.134.63.151 -P 3306 -u admin -p（连通性与权限验证）

十、故障排查清单
- 端口不可达：
  - 安全组未放通/云防火墙阻断；
  - 服务器 UFW/iptables 未放通或服务未监听 0.0.0.0；
  - 服务未启动或端口被占用。
- SSH 失败：
  - 密码错误/被禁用；
  - PermitRootLogin 被禁用（改用管理员账户或先用密钥）。
- API 超时：
  - 应用未启动或 Nginx 转发异常；
  - 防火墙阻断或后端端口未监听。
- MQTT 连接失败：
  - 帐号密码错误；
  - TLS/非 TLS 端口不匹配；
  - ACL 限制主题访问。

十一、后续计划
- 待云侧开放端口后，执行 SSH 登录与初始化，加固与服务安装；
- 部署后端 API 并联调 Android 客户端；
- 建立监控与告警、定期备份策略。