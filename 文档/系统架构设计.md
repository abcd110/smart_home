# 系统架构设计（Android 端与后端）

基于《功能设定.md》和《接口文档总结.md》，结合当前工程配置输出面向落地的架构设计文档，覆盖技术栈要求、架构设计与开发规范三部分。

---

## 一、技术栈要求

- 开发语言
  - Android：Java（建议 Java 11，AndroidX + MVVM）
  - 后端：Java（建议 Java 11，Spring Boot 2.7.x + Spring Security/JWT）

- Android 兼容性与依赖
  - AndroidX：AppCompat、Material、AndroidX Test 等
  - 架构组件：ViewModel、LiveData（Java 版本）
  - 网络/通信：OkHttp3 + Retrofit2（REST），Eclipse Paho（MQTT）
  - JSON：Gson

- JDK 版本
  - 统一 JDK 11（工程 compileOptions：Java 11）

- Android SDK 版本（根据现有工程配置）
  - compileSdk：36
  - targetSdk：36
  - minSdk：28

- 构建工具版本
  - Gradle Wrapper：8.14
  - Android Gradle Plugin（AGP）：8.12.0

- 服务器与通信（对齐接口文档）
  - REST API 基础 URL：http://8.134.63.151:8080/
  - API 版本前缀：v1
  - MQTT URI：tcp://8.134.63.151:1883（生产建议启用 TLS：8883）
  - MQTT 主题：
    - 设备状态：smart_community/devices/+/status
    - 传感器数据：smart_community/sensors/+/data
    - 安全事件：smart_community/security/events
    - 设备控制：smart_community/devices/{deviceId}/control
  - 数据库：MySQL（核心表：users、devices、device_data、security_events）

---

## 二、架构设计

### 2.1 分层架构（四层）
- 业务层（Domain）
  - 领域模型：User、Device、SensorData、SecurityEvent、Scene（离家/回家/夜间）
  - 领域服务：联动规则、阈值管理、告警判定、场景切换策略
- 应用层（Application）
  - Android：MVVM（ViewModel 协调 UI 与 Repository），认证管理、API 封装、MQTT 会话管理
  - 后端：Controller（REST）、Service（编排与校验）、消息网关（REST→MQTT）
- 数据层（Data）
  - Android：Repository 聚合 REST/MQTT/本地缓存；Gson 序列化；（可选）Room 本地持久化
  - 后端：MySQL 持久化（JPA/MyBatis），缓存（可选 Redis），MQTT 消费落库
- 基础设施层（Infra）
  - Android：日志、错误收集、配置中心（dev/prod 切换）
  - 后端：Spring Boot、JWT、统一异常处理、限流与重试、监控（Prom/Grafana 可选）、Nginx 可选

### 2.2 模块划分
- Android 端（建议包结构）
  - core-common：常量、工具、异常、环境配置（AppConfig/Env）
  - auth：登录/刷新/登出、Token 管理与并发刷新互斥
  - network-rest：Retrofit 客户端、拦截器、ApiService（设备/数据/事件/社区）
  - mqtt-client：MQTT 管理器、主题订阅/发布、消息解析与派发
  - devices：设备列表/详情/状态视图与逻辑
  - sensors：环境数据展示（实时 + 历史曲线）
  - security：安全事件列表/详情/处理状态更新
  - scene：场景模式（夜间/离家/回家）策略管理与 UI
  - ui：Activity/Fragment/ViewModel（按页面/功能分层）
  - storage：本地存储（SharedPreferences/Room）
  - testing：单元/集成测试
- 后端（建议服务划分）
  - auth-service：用户认证与 JWT（登录、刷新、登出）
  - device-service：设备管理、状态更新、命令下发（REST→MQTT）
  - sensor-data-service：数据上报/查询（REST 与 MQTT 消费）、历史检索
  - security-event-service：事件接收与处理状态管理
  - community-service：社区信息查询
  - mqtt-broker（外部）：Broker 部署与主题管理（Mosquitto/EMQX）
  - api-gateway（可选）：统一网关/鉴权/限流
  - persistence：MySQL ORM 层、备份归档

### 2.3 组件交互关系
- ESP32：采集数据与本地阈值联动；发布传感器数据/事件；订阅设备控制主题并执行
- Android：
  - REST 获取设备/数据/事件/社区信息
  - MQTT 订阅实时数据与事件；下发设备控制与场景指令（经后端转发）
  - Token 生命周期管理（登录/刷新/失效重试）
- 后端：REST 提供管理接口；MQTT Broker 接入；消费设备上报并落库；下发控制与事件派发

### 2.4 接口调用流程（关键场景）
- 用户登录/刷新
  1) Android：POST api/auth/login → 返回 AccessToken/RefreshToken
  2) 持久化 Token（加密存储）；请求拦截器附带 AccessToken
  3) 过期自动刷新：POST api/auth/refresh（互斥锁避免并发刷新）
- 设备列表/详情/状态
  1) GET v1/devices（分页）/GET v1/devices/{deviceId}
  2) MQTT 订阅 smart_community/devices/{deviceId}/status，实时更新 UI
- 传感器数据上报与展示
  1) ESP32 发布 smart_community/sensors/{deviceId}/data（JSON）
  2) 后端消费并入库 device_data；Android 端 GET v1/sensors/data 查询历史曲线
- 设备控制
  1) Android：POST v1/devices/{deviceId}/command（指令/参数）
  2) 后端校验 → 发布 smart_community/devices/{deviceId}/control → ESP32 执行 → status/data 回传
- 安全事件处理
  1) ESP32 发布 smart_community/security/events
  2) 后端入库并标记未处理；Android：GET v1/security/events 查询/订阅；PUT v1/security/events/{eventId}/process 标记处理

### 2.5 非功能性设计
- 性能与可用性
  - REST 超时 30s；MQTT 心跳 20s、连接超时 10s
  - 客户端请求重试：针对 408/429/5xx，指数退避，最多 3 次
  - 目标：MQTT 实时展示 ≤1s；REST 历史检索 P95 ≤300ms（索引/缓存）
- 安全
  - 后端 JWT 校验，Token 自动刷新；敏感数据本地加密存储
  - MQTT 生产启用 TLS、按主题授权；账号隔离
- 运维与监控
  - 备份：RPO ≤1h；RTO ≤10min（主从切换）
  - 指标：服务成功率≥99.9%，MQTT 处理延迟 P95 ≤1s，慢查询 ≤5 次/分钟

---

## 三、开发规范

### 3.1 代码结构（Android）
- 包原则（按业务与职责）：core-common、auth、network-rest、mqtt-client、devices、sensors、security、scene、ui、storage、testing
- 分层约束：
  - UI 不直接访问网络/MQTT；通过 ViewModel → Repository → DataSource
  - Repository 统一 REST/MQTT/本地存储，返回领域模型与通用响应（ApiResponse<T>、PagedResponse<T>）

### 3.2 命名规范
- Java
  - 类：大驼峰（DeviceService、SensorDataRepository）
  - 方法/变量：小驼峰（getDeviceList、sensorDataValue）
  - 常量：全大写下划线（DEFAULT_TIMEOUT_MS）
- JSON/DTO：camelCase（deviceId、dataType、timestamp），时间戳统一（ISO8601 或毫秒）
- 资源命名：layout（模块_页面，如 devices_list.xml）；id（功能_控件，如 sensor_chart）；string/dimen 语义清晰
- MQTT 主题：统一 smart_community 前缀，设备维度采用 {deviceId}

### 3.3 版本控制策略
- 分支（GitFlow）
  - main：稳定发布分支（打 tag）
  - develop：集成分支
  - feature/*：按功能拆分（如 feature/mqtt-client）
  - release/*：发布准备（回归测试、修复）
  - hotfix/*：紧急修复（从 main 分出，修复后合并回 main/develop）
- 提交（Conventional Commits）：feat/fix/docs/refactor/test/build/chore
- 版本号（SemVer）：主.次.修订（如 1.0.0）
- 合并与评审：所有 PR 需代码审查；启用静态检查（Lint、Checkstyle）；CI 执行测试与构建
- 配置与安全：服务器/MQTT 配置集中管理（dev/prod 切换），敏感信息不入库且不硬编码

---

## 结语
本架构设计文档面向实际落地，已与当前 Android 工程配置和接口文档对齐。后续可补充架构图（分层图、交互序列图）与里程碑计划（如：第1周完成网关与认证、第2周完成设备模块、第3周完成 MQTT 集成与压力测试）以支撑项目交付。